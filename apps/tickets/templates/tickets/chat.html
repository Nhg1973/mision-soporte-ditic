<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesa de Ayuda DITIC</title>
    <!-- Bootstrap 5 y FontAwesome para los íconos de estrellas -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { background-color: #f4f7f6; }
        .main-container {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 1.5rem;
            height: 90vh;
            margin-top: 5vh;
        }
        .sidebar { background-color: white; border-radius: 0.75rem; padding: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .chat-window { display: flex; flex-direction: column; background-color: white; border-radius: 0.75rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .chat-box { flex-grow: 1; overflow-y: auto; padding: 1.5rem; }
        .chat-message { margin-bottom: 1rem; display: flex; flex-direction: column; }
        .user-message { align-items: flex-end; }
        .system-message { align-items: flex-start; }
        .message-bubble { padding: 0.75rem 1rem; border-radius: 1rem; max-width: 75%; line-height: 1.5; }
        .user-message .message-bubble { background-color: #0d6efd; color: white; border-top-right-radius: 0.25rem; }
        .system-message .message-bubble { background-color: #e9ecef; color: #212529; border-top-left-radius: 0.25rem; }
        .message-sender { font-size: 0.8rem; color: #6c757d; margin: 0 0.5rem 0.25rem; }
        .ticket-list a { text-decoration: none; }
        .ticket-list .list-group-item { border-radius: 0.5rem !important; margin-bottom: 0.5rem; }
        /* Estilos para el sistema de calificación */
        .rating-stars a { color: #ccc; text-decoration: none; font-size: 1.5rem; transition: color 0.2s; }
        .rating-stars a:hover { color: #ffc107; }
        .rated { color: #ffc107 !important; }
    </style>
</head>
<body>
    <div class="container main-container">
        <!-- Barra Lateral con Historial de Tickets -->
        <div class="sidebar d-flex flex-column">
            <h4 class="mb-3">Mis Tickets</h4>
            <div class="ticket-list flex-grow-1 overflow-auto">
                <div class="list-group">
                    {% for ticket in tickets_del_usuario %}
                        <!-- ¡CAMBIO CLAVE AQUÍ! -->
                        <!-- El enlace ahora apunta a nuestra nueva URL 'select_ticket', pasándole el ID del ticket. -->
                        <a href="{% url 'tickets:select_ticket' ticket_id=ticket.id %}" class="list-group-item list-group-item-action {% if ticket_activo and ticket.id == ticket_activo.id %}active{% endif %}">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">Ticket #{{ ticket.id }}</h6>
                                <small>{{ ticket.fecha_creacion|date:"d M Y" }}</small>
                            </div>
                            <p class="mb-1 small text-muted">{{ ticket.descripcion_inicial|truncatewords:8 }}</p>
                            <span class="badge bg-light text-dark">{{ ticket.get_estado_display }}</span>
                        </a>
                    {% empty %}
                        <p class="text-center text-muted">No tienes tickets anteriores.</p>
                    {% endfor %}
                </div>
            </div>
            <div class="mt-3">
                <a href="{% url 'tickets:new_chat' %}" class="btn btn-primary w-100">Nuevo Ticket</a>
            </div>
        </div>

        <!-- Ventana Principal del Chat -->
        <div class="chat-window">
            <div class="chat-box" id="chat-box">
                <!-- Mensajes de la conversación activa -->
                {% for log in logs_conversacion %}
                    <div class="chat-message {% if log.emisor == 'USUARIO' %}user-message{% else %}system-message{% endif %}">
                        <span class="message-sender">{% if log.emisor == 'USUARIO' %}{{ user.username }}{% else %}Asistente DITIC{% endif %}</span>
                        <div class="message-bubble">
                            {{ log.mensaje|linebreaksbr }}
                        </div>
                    </div>
                {% empty %}
                    <p class="text-center text-muted">Selecciona un ticket o crea uno nuevo para comenzar.</p>
                {% endfor %}

                <!-- Sección de Calificación -->
                {% if ticket_activo and ticket_activo.estado == 'EN_PROCESO' %}
                    <div class="text-center mt-4 p-3 bg-light rounded">
                        {% if ticket_activo.calificacion %}
                            <p class="mb-1">¡Gracias por tu feedback!</p>
                            <p class="mb-0">Calificaste este ticket con:</p>
                            <div class="rating-stars">
                                {% for i in "12345" %}
                                    <i class="fa-solid fa-star {% if i|add:0 <= ticket_activo.calificacion %}rated{% endif %}"></i>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="mb-2">¿Te fue útil la solución? ¡Por favor, califica el soporte recibido!</p>
                            <div class="rating-stars">
                                <a href="{% url 'tickets:rate_ticket' ticket_id=ticket_activo.id rating=1 %}"><i class="fa-regular fa-star"></i></a>
                                <a href="{% url 'tickets:rate_ticket' ticket_id=ticket_activo.id rating=2 %}"><i class="fa-regular fa-star"></i></a>
                                <a href="{% url 'tickets:rate_ticket' ticket_id=ticket_activo.id rating=3 %}"><i class="fa-regular fa-star"></i></a>
                                <a href="{% url 'tickets:rate_ticket' ticket_id=ticket_activo.id rating=4 %}"><i class="fa-regular fa-star"></i></a>
                                <a href="{% url 'tickets:rate_ticket' ticket_id=ticket_activo.id rating=5 %}"><i class="fa-regular fa-star"></i></a>
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
            <div class="card-footer p-3">
                <!-- Formulario para enviar un nuevo mensaje -->
                <form method="post" action="{% url 'tickets:chat' %}">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="text" name="mensaje" class="form-control form-control-lg" placeholder="Escribe tu consulta aquí..." required autofocus>
                        <button class="btn btn-primary" type="submit">Enviar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Ventana contexto  -->
        <div class="sidebar"> <h4 class="mb-3">Contexto del Bot</h4>
            {% if graph_state %}
                <div class="card bg-light border-0">
                    <div class="card-body">
                        <p class="mb-2">
                            <strong><i class="fas fa-tag me-2"></i>Tema Detectado:</strong>
                            <span class="badge bg-primary">{{ graph_state.current_topic|default:"N/A" }}</span>
                        </p>
                        <p class="mb-0">
                            <strong><i class="fas fa-check-double me-2"></i>Confianza:</strong>
                            <span class="badge bg-secondary">{{ graph_state.topic_confidence|default:"N/A" }}</span>
                        </p>
                        {% if graph_state.topic_locked %}
                            <p class="mt-2 mb-0 text-success small">
                                <i class="fas fa-lock me-1"></i> Tema Fijado
                            </p>
                        {% endif %}
                    </div>
                </div>

                <div class="my-3">
                    <label for="topic-selector" class="form-label small">Corregir Tema:</label>
                    <select id="topic-selector" class="form-select form-select-sm" disabled>
                        <option>Funcionalidad en desarrollo</option>
                    </select>
                </div>

                <hr>

                <h5 class="h6 mb-3">Fuentes Consultadas</h5>
                {% if graph_state.relevant_docs %}
                    <ul class="list-group list-group-flush small">
                        {% for doc in graph_state.relevant_docs %}
                            <li class="list-group-item px-0">
                                <i class="fas fa-file-alt me-2 text-muted"></i>
                                <strong>{{ doc.metadata.source|default:"Desconocido" }}</strong>
                                <br>
                                <span class="text-muted">Página: {{ doc.metadata.page|default:"N/A" }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted small">No se consultaron documentos en la última interacción.</p>
                {% endif %}

            {% else %}
                <p class="text-muted">Inicia una conversación para ver el contexto del bot.</p>
            {% endif %}
        </div>

    </div>

    <script>
        // Script para hacer scroll automático al último mensaje
        const chatBox = document.getElementById('chat-box');
        chatBox.scrollTop = chatBox.scrollHeight;
    </script>
</body>
</html>
